---
  - name: Get major version
    shell: cat /opt/couchbase/VERSION.txt | cut -d '.' -f1
    register: cb_major_version

  - name: Wait for Admin service
    wait_for:
      port: "{{ couchbase_admin_port }}" 
      delay: 2

  - name: Initialize primary node
    shell: "{{ couchbase_bin_path }}/couchbase-cli node-init -c {{ couchbase_primary_node }}:{{ couchbase_admin_port }} --user={{ couchbase_admin }} --password={{ couchbase_password }} --cluster-init-username={{ couchbase_admin }} --node-init-hostname={{ ansible_fqdn }} --node-init-data-path={{ couchbase_data_path }} --node-init-index-path={{ couchbase_index_path }}"
    when: cb_major_version['stdout'] != "2"

  - name: Wait for Admin service
    wait_for:
      port: "{{ couchbase_admin_port }}"
      delay: 2

  - name: Configure cluster settings (version != 4)
    shell: "{{ couchbase_bin_path }}/couchbase-cli cluster-init -c {{ couchbase_primary_node }}:{{ couchbase_admin_port }} --user={{ couchbase_admin }} --password={{ couchbase_password }} --cluster-init-username={{ couchbase_admin }} --cluster-init-password={{ couchbase_password }} --cluster-init-port={{couchbase_admin_port}} --cluster-init-ramsize={{ couchbase_memory }}"
    when: cb_major_version['stdout'] != "4"

  - name: Configure cluster settings (version == 4)
    shell: "{{ couchbase_bin_path }}/couchbase-cli cluster-init -c {{ couchbase_primary_node }}:{{ couchbase_admin_port }} --user={{ couchbase_admin }} --password={{ couchbase_password }} --cluster-init-username={{ couchbase_admin }} --cluster-init-password={{ couchbase_password }} --cluster-init-port={{couchbase_admin_port}} --cluster-init-ramsize={{ couchbase_memory }} --services={{ couchbase_node_services }}"
    when: cb_major_version['stdout'] == "4"
