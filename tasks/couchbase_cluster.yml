---
  - name: Get major version
    shell: cat /opt/couchbase/VERSION.txt | cut -d '.' -f1
    register: couchbase_major_version

  - name: Wait for Admin service
    wait_for:
      port: "{{ couchbase_admin_port }}"
      delay: 2

  - name: Configure cluster settings (version < 4)
    shell: "{{ couchbase_bin_path }}/couchbase-cli cluster-init -c {{ couchbase_primary_node }}:{{ couchbase_admin_port }} --user={{ couchbase_admin_username }} --password={{ couchbase_admin_password }} --cluster-init-username={{ couchbase_admin_username }} --cluster-init-password={{ couchbase_admin_password }} --cluster-init-port={{ couchbase_admin_port }} --cluster-init-ramsize={{ couchbase_memory }}"
    when: couchbase_major_version['stdout'] < "4"
    register: couchbase_configure_cluster
    failed_when:
      - "couchbase_configure_cluster.stdout != 'SUCCESS: set memory quota successfully'"
      - "couchbase_configure_cluster.stdout != 'ERROR: unable to setup services (400) Bad Request\n[\"cannot change node services after cluster is provisioned\"]'"

  - name: Configure cluster settings (version >= 4)
    shell: "{{ couchbase_bin_path }}/couchbase-cli cluster-init -c {{ couchbase_primary_node }}:{{ couchbase_admin_port }} --user={{ couchbase_admin_username }} --password={{ couchbase_admin_password }} --cluster-init-username={{ couchbase_admin_username }} --cluster-init-password={{ couchbase_admin_password }} --cluster-init-port={{ couchbase_admin_port }} --cluster-init-ramsize={{ couchbase_memory }} --services={{ couchbase_node_services }}"
    when: couchbase_major_version['stdout'] >= "4"
    register: couchbase_configure_cluster
    failed_when:
      - "couchbase_configure_cluster.stdout != 'SUCCESS: set memory quota successfully'"
      - "couchbase_configure_cluster.stdout != 'ERROR: unable to setup services (400) Bad Request\n[\"cannot change node services after cluster is provisioned\"]'"

  - name: Join additional cluster nodes (version < 4)
    shell: "{{ couchbase_bin_path }}/couchbase-cli server-add -c {{ couchbase_primary_node }}:{{ couchbase_admin_port }} --user={{ couchbase_admin_username }} --password={{ couchbase_admin_password }} --server-add={{ hostvars[item[0]]['inventory_hostname'] }}:{{ couchbase_admin_port }} --server-add-username={{ couchbase_admin_username }} --server-add-password={{ couchbase_admin_password }}"
    with_items: "{{ groups['couchbase-additional'] }}"
    when: couchbase_major_version['stdout'] < "4"
    # TODO: make this task idempotent
    # register: couchbase_join_cluster
    # failed_when:
    #   - "couchbase_join_cluster.stdout != 'SUCCESS: server-add ' ~ hostvars[item[0]][inventory_hostname] ~ ':8091'"
    #   - "couchbase_join_cluster.stdout != 'ERROR: unable to server-add ' ~ hostvars[item[0]][inventory_hostname] ~ ':8091 (400) Bad Request\n[\"Prepare join failed. Node is already part of cluster.\"]'"

  - name: Join additional cluster nodes (version >= 4)
    shell: "{{ couchbase_bin_path }}/couchbase-cli server-add -c {{ couchbase_primary_node }}:{{ couchbase_admin_port }} --user={{ couchbase_admin_username }} --password={{ couchbase_admin_password }} --server-add={{ hostvars[[item][0]]['inventory_hostname'] }}:{{ couchbase_admin_port }} --server-add-username={{ couchbase_admin_username }} --server-add-password={{ couchbase_admin_password }} --services={{ couchbase_node_services }}"
    with_items: "{{ groups['couchbase-additional'] }}"
    when: couchbase_major_version['stdout'] >= "4"
    # TODO: make this task idempotent
    # register: couchbase_join_cluster
    # failed_when:
    #   - "couchbase_join_cluster.stdout != 'SUCCESS: server-add ' ~ hostvars[item[0]][inventory_hostname] ~ ':8091'"
    #   - "couchbase_join_cluster.stdout != 'ERROR: unable to server-add ' ~ hostvars[item[0]][inventory_hostname] ~ ':8091 (400) Bad Request\n[\"Prepare join failed. Node is already part of cluster.\"]'"

  - name: Rebalance cluster
    shell: "{{ couchbase_bin_path }}/couchbase-cli rebalance -c {{ couchbase_primary_node }}:{{ couchbase_admin_port }} --user={{ couchbase_admin_username }} --password={{ couchbase_admin_password }}"
